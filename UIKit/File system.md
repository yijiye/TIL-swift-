# File System Basics
> 데이터 파일, 앱 및 운영 체제 자체와 관련된 파일의 지속적인 저장을 처리한다.

- **기본 자원 중 하나이다.**
- **APFS는 macOS, iOS, watchOS 및 tvOS의 기본 파일 시스템이다.**
APFS는 HFS+를 iOS 10.3 이상과 macOS High Sierra 이상용 기본 파일 시스템으로 대체한다. macOS는 다양한 다른 형식을 추가로 지원한다.
- **모든 디스크는 단일 file collection을 만들 수 있는 공간을 제공한다.**
기본 형식에 관계없이, 물리적으로 연결되어 있든 네트워크를 통해 간접적으로 연결되어 있든 장치에 연결된 모든 디스크는 단일 파일 컬렉션을 만들 수 있는 공간을 제공한다. 
파일의 수는 쉽게 수백만 개가 될 수 있기 때문에, 파일 시스템은 디렉토리를 사용하여 계층적 조직을 만든다. 기본 디렉토리 구조는 iOS와 macOS에서 비슷하지만, 각 시스템이 앱과 사용자 데이터를 구성하는 방식에는 차이가 있다.
- **파일 시스템의 구성과 코드에 적용되는 규칙에 대한 이해가 필요하다.**
코드를 작성하기전, 규칙에 대한 이해가 필요하다.
  - 보안 권한이 없는 디렉토리에 파일을 쓸 수 없다.
  - 앱은 파일시스템의 좋은 시민이 되어 파일을 적절한 위치에 놓아야 한다.
  - 사용자의 파일이 쉽게 발견 가능하고 코드가 내부적으로 사용하는 파일은 사용자의 방해를 받지 않도록 해야한다.

## iOS File System
> 파일 시스템이 자체적으로 실행되는 앱에 맞춰져 있다.
> 시스템을 단순하게 유지하기 위해, iOS 장치 사용자는 파일 시스템에 직접 액세스할 수 없으며 앱은 이 규칙을 따를 것으로 예상된다.

### iOS 표준 디렉토리: 파일이 있는 곳

iOS 앱의 파일 시스템과의 상호작용은 앱의 샌드박스 디렉토리 내의 디렉토리로 제한된다.
  * **샌드박스란,** iOS 운영체제에서 앱이 실행되는 환경을 격리된 영역으로 만들어 보안을 강화하는 기술
  iOS는 각 앱마다 고유한 샌드박스가 할당되어 있으며, 자신의 샌드박스 디렉토리 내에서만 파일시스템과 상호작용할 수 있다.


새로운 앱을 설치할 때, 설치 프로그램은 샌드박스 디렉토리 내에 앱을 위한 여러 컨테이너 디렉토리를 생성한다.
- Bundle Container : 앱의 번들 보관
   **번들이란,** iOS 앱의 실행 파일, 리소스 및 기타 필수 파일을 모아둔 디렉토리
   앱이 설치될 때 압축되어 배포되며, 앱의 실행파일, 앱 아이콘, 스토리보드, 이미지, 사운드 등 모든 리소스를 포함한다.
- Data Container : 앱과 사용자 모두를 위한 데이터 보관
앱이 데이터를 정리하고 구성하는데 사용할 수 있는 하위 디렉토리로 더 나눠진다.
- iCloud Container : 추가적인 컨테이너로, 앱은 런타임에 추가 디렉토리 컨테이너에 대한 액세스를 요청할 수도 있다.

<img src="https://i.imgur.com/MW5DXcf.png" width="400">

앱은 일반적으로 디렉토리 외부 파일에 대한 접근, 생성을 금지하지만 예외적인 경우 helper 앱을 사용하여 접근하도록 한다.
 - 예외상황: 사용자의 연락처나 음악과 같은 것에 접근하기 위해 앱이 공개된 시스템 인터페이스를 사용하는 경우 시스템 프레임 워크는 해당 데이터 저장소를 읽거나 수정하는데 필요한 파일 작업을 처리하기 위해 helper 앱을 사용한다.

샌드박스 디렉토리 내에서 중요한 하위 디렉토리와 그 디렉토리의 사용방법 (표1-1)



| 이름            | 설명                                                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| AppName.app     | - 앱 번들. 앱과 모든 리소스가 포함되어 있다. </br> - 조작 방지를 위해 번들 디렉토리는 설치 시에 서명되고 이후에 변경되어 앱을 실행할 수 없다.  </br> -모든 리스소에 대해 읽기 전용 액세스가 허용된다.  </br> - iTunes, iCloud에 백업되지 않으나 App store에서 구입한 앱은 iTunes에서 초기 동기화를 한다.                                                                                                                          |
| Documents/      | - 사용자가 생성한 콘텐츠를 저장한다.</br> - 이 디렉토리의 내용은 파일 공유를 통해 사용자에게 제공될 수 있어, 노출하고 싶은 파일만 포함해야 한다. </br> - iTunes, iCloud에 백업된다.                                                                                                                                                                                                                                               |
| Documents/Inbox | - 외부 실체에서 앱이 열도록 요청된 파일에 접근하기 위해 사용된다. </br> - Mail 프로그램은 이 디렉토리에 앱과 관련된 이메일 첨부파일을 넣는다. 문서 상호작용 컨트롤러도 넣을 수 있다. </br> - 이 디렉토리에서 파일을 읽거나 삭제할 수 있지만, 새 파일을 생성하거나 기존 파일에 쓸 수는 없다. </br> - 사용자가 이 디렉토리 내부 파일을 편집하려면 앱이 파일이 수정되기 전 디렉터리에서 빼야한다. </br> - iTunes, iCloud에 백업된다. |
| Libraray/ |  - 사용자 데이터 파일이 아닌 모든 파일을 위한 최상위 디렉토리이다. </br> - 여러 표준 하위 디렉토리 중 하나에 파일을 넣으면 Application Support, Caches 하위 디렉토리를 사용, 사용자 정의도 만들 수 있음 </br> - 하위 디렉토리에는 사용자에게 노출되지 않는 파일을 사용. 앱은 이 디렉토리를 사용자 데이터 파일에 사용하지 않아야 한다. </br> - iTunes, iCloud에 백업된다. (Caches 하위 디렉토리를 제외한) |
| tmp/ | - 앱을 시작할 때 유지할 필요가 없는 일시적은 파일을 쓰기 위함 </br> - 앱은 이 디렉토리에서 파일을 제거해야 한다.  </br> - 앱이 실행되지 않을 때 시스템이 이 디렉토리를 지울 수 있다.  </br> - iTunes, iCloud에 백업되지 않는다. |

파일을 잘 정리하기 위해 iOS 앱은 문서, 라이브러리 및 tmp 디렉토리에 추가 디렉토리를 만들 수 있다.

### 앱 파일을 둬야 하는 곳 
> 동기화와 백업 프로세스가 오래 걸리는 것을 방지하기 위해 파일 저장하는 위치가 중요하다.

- **사용자 데이터 :  Documents/** 
사용자 데이터는 노출시키고 싶은 파일
- **앱에서 생성한 지원 파일 : Library/Application support/**
이 디렉토리는 앱이 실행되는데 사용되지만 사용자에게 숨겨야 하는 파일이 포함.
데이터 파일, 구성 파일, 템플릿 및 앱 번들에서 로드된 자원의 수정된 버전도 포함 가능.
- **재생성하거나 다운로드할 수 있는 파일은 반드시 백업에서 제외시켜야 한다. (큰 미디어 파일, 비디오/ 오디오 파일 등)**
Documents/, Application Support/ 파일은 기본적으로 백업된다.
NSURLIsExcludedFromBackupKey 키를 사용하여 -[NSURL setResourceValue:forKey:error:]를 호출하여 백업에서 파일을 제외할 수 있다. 재생성하거나 다운로드할 수 있는 파일은 반드시 백업에서 제외해야 한다. 이는 특히 큰 미디어 파일에 대해 중요하고 앱이 비디오 또는 오디오 파일을 다운로드하는 경우 백업에 포함되지 않도록 해야 한다.
- **임시 데이터 : tmp/**
오래 지속될 필요가 없는 모든 데이터를 칭함.
사용을 마치면 삭제해야 하고 디바이스의 공간을 계속 차지하지 않는다.
파일 다운로드 할때, 임시폴더에 다운로드를 받고 다운로드가 완료되면 필요한 곳으로 이동 (목적지에 바로 다운로드 되는게 아니다)
- **데이터 캐시 파일 : Library/Caches/**
캐시 데이터는 일시적인 데이터보다 오래 유지되어야 하지만 지원 파일만큼 유지될 필요는 없는 모든 데이터를 사용.
일반적으로 캐시 데이터가 필수적으로 동작하지는 않지만 캐시 데이터를 사용하여 성능을 높일 수 있다. (예시, 일시적으로 다운로드 되는 콘텐츠/ 데이터베이스 캐시 파일)
Caches/ 디렉토리는 삭제할 수 있으므로 앱은 필요할 때 언제든 다시 파일을 만들거나 다운로드할 수 있어야 한다. (서버요청을 하거나)

## 참고
[공식문서](https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemProgrammingGuide/FileSystemOverview/FileSystemOverview.html)
